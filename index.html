<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>4K Video Merger - Low RAM Version</title>
    
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0a0a0a; color: white; text-align: center; padding: 20px; }
        .container { max-width: 550px; margin: auto; background: #161616; padding: 30px; border-radius: 15px; border: 1px solid #333; }
        .status-box { padding: 10px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; font-size: 14px; }
        .ok { background: #1b4332; color: #74c69d; }
        .error { background: #431b1b; color: #ff8787; }
        .drop-zone { border: 2px dashed #444; padding: 25px; margin: 10px 0; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .drop-zone:hover { border-color: #00d1b2; background: #1f1f1f; }
        .ready { border-color: #00d1b2; color: #00d1b2; }
        button { width: 100%; background: #00d1b2; color: black; border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; }
        button:disabled { background: #333; color: #666; cursor: not-allowed; }
        #log { font-size: 12px; color: #888; margin-top: 15px; line-height: 1.5; }
        progress { width: 100%; height: 12px; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>4K Video Merger (MP4)</h2>
    
    <div id="status-shield" class="status-box error">‚ö†Ô∏è REFRESH (F5) NECESAR</div>

    <div id="v-zone" class="drop-zone">√éncarcƒÉ Video (.webm)</div>
    <div id="a-zone" class="drop-zone">√éncarcƒÉ Audio (.mp3)</div>

    <button id="process-btn" disabled>PORNE»òTE CONVERSIA 4K</button>
    <progress id="p-bar" value="0" max="100"></progress>
    <div id="log">A»ôteptare fi»ôiere...</div>
</div>

<script>
    const shield = document.getElementById('status-shield');
    const btn = document.getElementById('process-btn');
    const log = document.getElementById('log');
    const pBar = document.getElementById('p-bar');

    // VerificƒÉm dacƒÉ mediul este izolat (SharedArrayBuffer activ)
    if (window.crossOriginIsolated) {
        shield.innerText = "üõ°Ô∏è SECURITATE OK: Motor pornit";
        shield.className = "status-box ok";
        btn.disabled = false;
    }

    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });
    let videoFile, audioFile;

    function setup(id, type) {
        const zone = document.getElementById(id);
        zone.onclick = () => {
            const input = document.createElement('input'); input.type = 'file';
            input.onchange = e => {
                const f = e.target.files[0];
                if(type === 'v') videoFile = f; else audioFile = f;
                zone.innerText = "‚úÖ " + f.name;
                zone.classList.add('ready');
            };
            input.click();
        };
    }
    setup('v-zone', 'v'); setup('a-zone', 'a');

    btn.onclick = async () => {
        if(!videoFile || !audioFile) return alert("SelecteazƒÉ ambele fi»ôiere!");
        
        btn.disabled = true;
        pBar.style.display = "block";
        log.innerText = "Ini»õializare FFmpeg...";

        if(!ffmpeg.isLoaded()) await ffmpeg.load();

        ffmpeg.setProgress(({ ratio }) => {
            pBar.value = ratio * 100;
            log.innerText = `Procesare 4K: ${Math.round(ratio * 100)}%`;
        });

        log.innerText = "√éncƒÉrcare fi»ôiere √Æn RAM...";
        ffmpeg.FS('writeFile', 'v', await fetchFile(videoFile));
        ffmpeg.FS('writeFile', 'a', await fetchFile(audioFile));

        log.innerText = "Randare 4K √Æn curs... (VƒÉ rugƒÉm a»ôtepta»õi)";

        try {
            // ComandƒÉ optimizatƒÉ pentru a evita OOM (Out of Memory)
            await ffmpeg.run(
                '-i', 'v', 
                '-i', 'a', 
                '-vf', 'scale=3840:2160:force_original_aspect_ratio=decrease,pad=3840:2160:(ow-iw)/2:(oh-ih)/2',
                '-c:v', 'libx264', 
                '-preset', 'ultrafast', 
                '-crf', '28', 
                '-map', '0:v:0', 
                '-map', '1:a:0', 
                '-shortest', 
                'output_4k.mp4'
            );

            const data = ffmpeg.FS('readFile', 'output_4k.mp4');
            const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
            
            log.innerHTML = `<a href="${url}" download="final_4k.mp4" style="color:#00d1b2; font-size:18px; font-weight:bold;">‚¨áÔ∏è DESCARCƒÇ VIDEO 4K (.MP4)</a>`;
        } catch (err) {
            log.innerText = "EROARE RAM: Fi»ôierul este prea mare pentru browser.";
            console.error(err);
        }
        btn.disabled = false;
    };
</script>
</body>
</html>
