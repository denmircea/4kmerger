<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4K Video Merger - Pro</title>
    
    <script>
        window.coi = { doRegistration: true, quiet: false };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/coi-serviceworker/0.1.7/coi-serviceworker.min.js"></script>
    
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f0f0f; color: white; display: flex; justify-content: center; padding: 40px; }
        .card { background: #1a1a1a; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.7); width: 100%; max-width: 500px; text-align: center; border: 1px solid #333; }
        .shield { padding: 10px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; font-size: 14px; }
        .shield-ok { background: #1b4332; color: #74c69d; border: 1px solid #2d6a4f; }
        .shield-fail { background: #431b1b; color: #ff8787; border: 1px solid #6a2d2d; }
        .drop-zone { border: 2px dashed #444; padding: 30px; margin: 10px 0; border-radius: 12px; cursor: pointer; transition: 0.3s; }
        .drop-zone:hover { border-color: #00d1b2; background: #222; }
        .selected { border-color: #00d1b2; color: #00d1b2; background: rgba(0, 209, 178, 0.05); }
        button { width: 100%; background: #00d1b2; color: black; border: none; padding: 15px; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 15px; }
        button:disabled { background: #333; color: #777; cursor: not-allowed; }
        #progress-container { width: 100%; background: #333; height: 8px; border-radius: 4px; margin-top: 20px; display: none; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background: #00d1b2; transition: width 0.3s; }
        #log { font-size: 12px; color: #888; margin-top: 15px; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="margin-top:0">Video Merger 4K</h2>
    
    <div id="security-shield" class="shield shield-fail">Se verificƒÉ securitatea...</div>

    <div id="video-drop" class="drop-zone">Trage VIDEO (.webm)</div>
    <div id="audio-drop" class="drop-zone">Trage AUDIO (.mp3)</div>

    <button id="start-btn" disabled>PORNE»òTE CONVERSIA</button>

    <div id="progress-container">
        <div id="progress-bar"></div>
    </div>
    <p id="status-text" style="font-size: 14px; color: #bbb;"></p>
    <div id="log">A»ôteptare fi»ôiere...</div>
</div>

<script>
    const shield = document.getElementById('security-shield');
    const startBtn = document.getElementById('start-btn');
    const log = document.getElementById('log');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const statusText = document.getElementById('status-text');

    // VERIFICARE SECURITATE (SharedArrayBuffer)
    if (window.crossOriginIsolated) {
        shield.innerText = "üõ°Ô∏è SECURITATE OK: SharedArrayBuffer activ";
        shield.className = "shield shield-ok";
        startBtn.disabled = false;
    } else {
        shield.innerText = "‚ö†Ô∏è EROARE: DƒÉ Refresh (F5) pentru activare";
        shield.className = "shield shield-fail";
        console.warn("SharedArrayBuffer nu este disponibil √ÆncƒÉ. Service Worker-ul are nevoie de refresh.");
    }

    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });
    let videoFile, audioFile;

    // Configurare zone de drop
    function setupDrop(id, type) {
        const zone = document.getElementById(id);
        zone.onclick = () => {
            const input = document.createElement('input'); input.type = 'file';
            input.onchange = e => handleFile(e.target.files[0], zone, type);
            input.click();
        };
        zone.ondragover = e => { e.preventDefault(); zone.style.borderColor = "#00d1b2"; };
        zone.ondragleave = () => { zone.style.borderColor = "#444"; };
        zone.ondrop = e => { e.preventDefault(); handleFile(e.dataTransfer.files[0], zone, type); };
    }

    function handleFile(file, zone, type) {
        if (!file) return;
        if (type === 'v') videoFile = file; else audioFile = file;
        zone.innerText = "‚úÖ " + file.name;
        zone.classList.add('selected');
        log.innerText = "Fi»ôiere gata pentru procesare.";
    }

    setupDrop('video-drop', 'v');
    setupDrop('audio-drop', 'a');

    startBtn.onclick = async () => {
        if (!videoFile || !audioFile) return alert("SelecteazƒÉ ambele fi»ôiere!");
        
        startBtn.disabled = true;
        progressContainer.style.display = 'block';
        log.innerText = "Se ini»õializeazƒÉ motorul FFmpeg...";

        if (!ffmpeg.isLoaded()) await ffmpeg.load();

        ffmpeg.setProgress(({ ratio }) => {
            const pct = Math.round(ratio * 100);
            progressBar.style.width = pct + "%";
            statusText.innerText = "Procesare 4K: " + pct + "%";
        });

        log.innerText = "Se √ÆncarcƒÉ fi»ôierele √Æn RAM...";
        ffmpeg.FS('writeFile', 'in_v.webm', await fetchFile(videoFile));
        ffmpeg.FS('writeFile', 'in_a.mp3', await fetchFile(audioFile));

        log.innerText = "Conversie 4K √ÆnceputƒÉ... (Nu √Ænchide pagina!)";

        // Comanda FFmpeg pentru scalare 4K si mixare
        await ffmpeg.run(
            '-i', 'in_v.webm', 
            '-i', 'in_a.mp3', 
            '-vf', 'scale=3840:2160:force_original_aspect_ratio=decrease,pad=3840:2160:(ow-iw)/2:(oh-ih)/2', 
            '-map', '0:v:0', 
            '-map', '1:a:0', 
            '-shortest', 
            'output_4k.webm'
        );

        const data = ffmpeg.FS('readFile', 'output_4k.webm');
        const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/webm' }));
        
        statusText.innerHTML = `<a href="${url}" download="video_final_4k.webm" style="color:#00d1b2; font-weight:bold; text-decoration:none; font-size:18px;">‚¨áÔ∏è DESCARCƒÇ VIDEO 4K</a>`;
        log.innerText = "Finalizat cu succes!";
        startBtn.disabled = false;
    };
</script>

</body>
</html>
